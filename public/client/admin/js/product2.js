import{a as Y,d as b}from"./index.esm.js";import{l as z,r as c,j as M,w as J,W as Q,U as Z,X as e,ab as f,a0 as ee,H as a,a4 as B,$ as r,K as $,m as y}from"./vue-codemirror.js";import{j as ae,a1 as le,V as te,n as p,o as h,$ as oe,E as D,X as ie,G as I,Y as ne,D as de,F as R,s as A}from"./index.js";import{l as ue}from"./lodash.js";import{M as N}from"./ModuleDetail.js";import{V as T}from"./VTooltip.js";import{V as se,a as re}from"./VRow.js";import{V as ce}from"./VAutocomplete.js";import{V as P}from"./VSpacer.js";import{_ as j,a as me}from"./FilesTable.vue_vue_type_script_setup_true_lang.js";import{_ as pe}from"./RelationAutocomplete.vue_vue_type_script_setup_true_lang.js";import"./SmartForm.vue_vue_type_script_setup_true_lang.js";const fe={class:"ml-2"},ve=f("div",null,null,-1),Ve={style:{"margin-left":"-12px"}},ge=f("span",null,"Создать",-1),ye=f("span",null,"Удалить выбранное",-1),he=f("span",null,"Поиск",-1),ke=z({__name:"RelationsWithKeyTable",props:{moduleKey:{},modelValue:{default:()=>[]},showActions:{type:Boolean},initialValues:{default:()=>({})},itemTitle:{}},emits:["update:model-value"],setup(t,{emit:k}){const u=k,w=ae(),n=le(),d=c(!1),v=c(!1),V=c(""),g=c([]),K=c([]),C=c([]),E=c(),m=M(()=>w.modules[t.moduleKey]),_=M({get:()=>ue.orderBy(t.modelValue,["order","created_at"],["desc"]),set:i=>u("update:model-value",i)}),H=M(()=>{if(!t.showActions)return m.value.headers||[];const i={key:"actions",title:"Действия"};return m.value.headers?[...m.value.headers,i]:[]}),F=()=>{v.value=!1,g.value=[],V.value=""},W=async()=>{try{u("update:model-value",[...t.modelValue,...g.value]),g.value=[],v.value=!1}catch(i){console.log(i)}},X=async(i="")=>{try{const{data:o}=await A.get(`/api/admin/${m.value.key}`,{params:{search:i}});K.value=o}catch(o){console.log(o)}},q=()=>{u("update:model-value",t.modelValue.filter(i=>!C.value.includes(i.id)))},S=i=>{u("update:model-value",[...t.modelValue,{...i,pivot:{value:""}}]),n.onModalClose()},G=()=>{n.addModal({component:N,props:{modal:!0,moduleKey:t.moduleKey,initialValues:t.initialValues},actions:{onClose:n.onModalClose,onCreate:S}}),n.show=!0},U=async(i,o)=>{d.value=!0;try{const{data:l}=await A.patch(`/api/admin/${m.value.key}/${i}`,{order:o}),s=t.modelValue.findIndex(O=>O.id===l.id);if(s===-1)return;const x=[...t.modelValue];x.splice(s,1,l),u("update:model-value",x)}catch(l){console.log(l)}finally{d.value=!1}},L=(i,o)=>{i.target instanceof HTMLInputElement||(E.value=o.item.id,n.addModal({component:N,props:{modal:!0,id:o.item.id,moduleKey:t.moduleKey,initialValues:t.initialValues},actions:{onClose:n.onModalClose,onCreate:S}}),n.show=!0)};return J(()=>V.value,()=>{X(V.value)}),(i,o)=>(Q(),Z(I,{variant:"tonal",flat:"",loading:d.value,"prepend-icon":m.value.icon,class:"mb-8"},{title:e(()=>[f("span",fe,ee(m.value.title),1)]),default:e(()=>[a(oe,{modelValue:C.value,"onUpdate:modelValue":o[0]||(o[0]=l=>C.value=l),"show-select":"",headers:H.value,items:_.value,itemsPerPage:_.value.length,"items-length":_.value.length,loading:d.value,"onClick:row":L},{bottom:e(()=>[ve]),"item.value":e(({item:l})=>[a(te,{density:"compact","hide-details":"",modelValue:l.pivot.value,"onUpdate:modelValue":s=>l.pivot.value=s},null,8,["modelValue","onUpdate:modelValue"])]),"item.actions":e(({item:l})=>[f("div",Ve,[a(p,{icon:"",large:"",loading:d.value,flat:"",onClick:B(s=>U(l.id,Number(l.order)+1),["stop"])},{default:e(()=>[a(h,null,{default:e(()=>[r("mdi-arrow-up-bold-circle-outline")]),_:1})]),_:2},1032,["loading","onClick"]),a(p,{icon:"",large:"",loading:d.value,flat:"",onClick:B(s=>U(l.id,Number(l.order)-1),["stop"])},{default:e(()=>[a(h,null,{default:e(()=>[r("mdi-arrow-down-bold-circle-outline")]),_:1})]),_:2},1032,["loading","onClick"])])]),_:2},1032,["modelValue","headers","items","itemsPerPage","items-length","loading"]),a(D),a(R,null,{default:e(()=>[a(T,{location:"top",text:"Создать",color:"primary"},{activator:e(l=>[a(p,$({icon:"",large:""},{...l.props},{loading:d.value,onClick:G,flat:""}),{default:e(()=>[a(h,null,{default:e(()=>[r("mdi-plus")]),_:1})]),_:2},1040,["loading"])]),default:e(()=>[ge]),_:1}),a(T,{location:"top",text:"Удалить выбранное",color:"primary"},{activator:e(({props:l})=>[a(p,$({icon:"",large:"",loading:d.value},l,{flat:"",onClick:q}),{default:e(()=>[a(h,null,{default:e(()=>[r("mdi-delete")]),_:1})]),_:2},1040,["loading"])]),default:e(()=>[ye]),_:1}),a(ie,{modelValue:v.value,"onUpdate:modelValue":o[4]||(o[4]=l=>v.value=l),"close-on-content-click":!1,location:"right",offset:"16"},{activator:e(l=>[a(T,{location:"top",text:"Поиск",color:"primary"},{activator:e(s=>[a(p,$({icon:"",large:""},{...s.props,...l.props},{loading:d.value,flat:"",onClick:o[1]||(o[1]=x=>v.value=!0)}),{default:e(()=>[a(h,null,{default:e(()=>[r("mdi-magnify")]),_:1})]),_:2},1040,["loading"])]),default:e(()=>[he]),_:2},1024)]),default:e(()=>[a(I,{width:"500"},{default:e(()=>[a(ne,null,{default:e(()=>[r("Найти")]),_:1}),a(de,{class:"mt-2"},{default:e(()=>[a(se,null,{default:e(()=>[a(re,null,{default:e(()=>[a(ce,{placeholder:"Поиск",modelValue:g.value,"onUpdate:modelValue":o[2]||(o[2]=l=>g.value=l),"return-object":"",chips:"",search:V.value,"onUpdate:search":o[3]||(o[3]=l=>V.value=l),items:K.value,"item-title":i.itemTitle,multiple:""},null,8,["modelValue","search","items","item-title"])]),_:1})]),_:1})]),_:1}),a(D),a(R,null,{default:e(()=>[a(P),a(p,{variant:"text",onClick:F},{default:e(()=>[r(" Отмена ")]),_:1}),a(p,{color:"primary",variant:"text",onClick:W},{default:e(()=>[r(" Добавить ")]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),a(P)]),_:1})]),_:1},8,["loading","prepend-icon"]))}});function De(t){var u,w,n;console.log((u=t==null?void 0:t.initialValues)==null?void 0:u.category_id);const k=c([{component:"v-text-field",key:"title",props:{autocomplete:"title",label:"Название",name:"title",type:"text"},rule:Y().required()},{component:"v-text-field",key:"order",props:{autocomplete:"order",label:"Приоритет",name:"order",type:"number"},rule:b()},{component:"v-text-field",key:"price",props:{autocomplete:"price",label:"Цена",name:"price",suffix:"₽"},rule:b()},{component:"v-text-field",key:"weight",props:{autocomplete:"weight",label:"Вес",name:"weight",suffix:"мл/гр"},rule:b()},{component:y(pe),key:"category_id",props:{autocomplete:"category_id",label:"Категория",name:"category_id",readonly:!!((w=t==null?void 0:t.initialValues)!=null&&w.category_id),itemValue:"id",itemTitle:"title",moduleKey:"category"}},{component:y(ke),key:"attributes",props:{moduleKey:"attribute",showActions:!1,itemTitle:"name"}},{component:y(j),key:"nutritional"},{component:y(j),key:"description"}]);return(n=t==null?void 0:t.entity)!=null&&n.id&&k.value.push({component:y(me),key:"images",props:{title:"Изображения",type:"image"}}),k.value}export{De as default};
