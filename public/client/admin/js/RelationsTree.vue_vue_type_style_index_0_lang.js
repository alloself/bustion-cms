import{p as de,I as re,P as me,g as ue,h as ce,a2 as D,a3 as R,n as p,a4 as ve,a5 as fe,a1 as pe,j as Ve,E as U,o as j,X as ye,G as E,Y as ge,D as Ce,F as G,s as B}from"./index.js";import{l as L}from"./lodash.js";import{M as X}from"./ModuleDetail.js";import{H as e,l as P,i as M,r as V,V as ke,W as w,U as S,X as t,K,u as m,a6 as Y,$ as k,a0 as A,ah as we,ab as T,Y as H,F as W,Z,j as O,q as F,w as Te}from"./vue-codemirror.js";import{V as z}from"./VTooltip.js";import{V as he,a as $e}from"./VRow.js";import{V as Se}from"./VAutocomplete.js";import{V as q}from"./VSpacer.js";const be=de({start:Boolean,end:Boolean,...re(),...me()},"VListItemAction"),I=ue()({name:"VListItemAction",props:be(),setup(a,y){let{slots:d}=y;return ce(()=>e(a.tag,{class:["v-list-item-action",{"v-list-item-action--start":a.start,"v-list-item-action--end":a.end},a.class],style:a.style},d)),{}}}),J=Symbol(),Q=Symbol(),x=Symbol(),Ie={style:{"margin-left":"-12px"}},Me={style:{"margin-left":"32px"}},Be={style:{"margin-left":"-12px"}},Ke=P({__name:"TreeViewItem",props:{item:{},itemTitle:{type:[Object,Function,String]}},setup(a){const y=M("selected",V([])),d=M(Q,()=>{}),g=M(J,async()=>{}),c=M(x,()=>{}),v=l=>{if(typeof a.itemTitle=="function")return a.itemTitle(l);{const o=a.itemTitle;return L.get(l,o)}},r=l=>L.orderBy(l,["order","created_at"],["desc"]);return(l,o)=>{const b=ke("tree-view-item",!0);return l.item.children&&l.item.children.length?(w(),S(ve,{key:0,"expand-icon":void 0},{activator:t(({props:u,isOpen:C})=>[e(D,K({onClick:o[3]||(o[3]=f=>m(c)(f,l.item))},{class:u.class,id:u.id}),{title:t(()=>[Y(l.$slots,"content",{item:l.item},()=>[k(A(v(l.item)),1)])]),prepend:t(()=>[e(I,{start:""},{default:t(()=>[e(R,{"model-value":m(y).includes(l.item.id),onClick:o[0]||(o[0]=f=>m(d)(l.item))},null,8,["model-value"])]),_:1}),e(I,{start:""},{default:t(()=>[e(p,{icon:"mdi-chevron-down",variant:"text",size:"small",onClick:u.onClick,class:we(["expand-icon",{active:C}])},null,8,["onClick","class"])]),_:2},1024)]),append:t(()=>[e(I,{end:""},{default:t(()=>[T("div",Ie,[e(p,{icon:"mdi-arrow-up-bold-circle-outline",size:"small",variant:"text",onClick:o[1]||(o[1]=f=>m(g)(l.item,Number(l.item.order)+1))}),e(p,{icon:"mdi-arrow-down-bold-circle-outline",size:"small",variant:"text",onClick:o[2]||(o[2]=f=>m(g)(l.item,Number(l.item.order)-1))})])]),_:1})]),_:2},1040)]),default:t(()=>[T("div",Me,[(w(!0),H(W,null,Z(r(l.item.children),u=>(w(),S(b,{key:u.id,item:u,"item-title":l.itemTitle},null,8,["item","item-title"]))),128))])]),_:3})):(w(),S(D,{key:1,onClick:o[7]||(o[7]=u=>m(c)(u,l.item))},{title:t(()=>[Y(l.$slots,"content",{item:l.item},()=>[k(A(v(l.item)),1)])]),prepend:t(()=>[e(I,{start:""},{default:t(()=>[e(R,{"model-value":m(y).includes(l.item.id),onClick:o[4]||(o[4]=u=>m(d)(l.item))},null,8,["model-value"])]),_:1})]),append:t(()=>[e(I,{end:""},{default:t(()=>[T("div",Be,[e(p,{icon:"mdi-arrow-up-bold-circle-outline",size:"small",flat:"",onClick:o[5]||(o[5]=u=>m(g)(l.item,Number(l.item.order)+1))}),e(p,{icon:"mdi-arrow-down-bold-circle-outline",size:"small",flat:"",onClick:o[6]||(o[6]=u=>m(g)(l.item,Number(l.item.order)-1))})])]),_:1})]),_:3}))}}}),Fe=P({__name:"TreeView",props:{items:{default:()=>[]},itemTitle:{},modelValue:{default:()=>[]}},emits:["update:model-value","item:click"],setup(a,{emit:y}){const d=y,g=O(()=>L.orderBy(a.items,["order","created_at"],["desc"])),c=r=>{const l=[...a.modelValue,r];d("update:model-value",l)},v=(r,l)=>d("item:click",r,l);return F("selected",a.modelValue),F(Q,c),F(x,v),(r,l)=>(w(),S(fe,{density:"compact",nav:"","return-object":""},{default:t(()=>[(w(!0),H(W,null,Z(g.value,(o,b)=>(w(),S(Ke,{key:b,item:o,"item-title":r.itemTitle},null,8,["item","item-title"]))),128))]),_:1}))}}),Le={class:"ml-2"},Ne=T("span",null,"Создать",-1),je=T("span",null,"Удалить выбранное",-1),ze=T("span",null,"Поиск",-1),Xe=P({__name:"RelationsTree",props:{modelValue:{default:()=>[]},moduleKey:{},relationKey:{},initialValues:{},itemTitle:{default:"name"}},emits:["update:model-value","create:children"],setup(a,{emit:y}){const d=pe(),g=Ve(),c=V(!1),v=V(""),r=V([]),l=V([]),o=M("loading",V(!1)),b=V(!1),u=V(),C=y,f=V([]),_=O({get:()=>L.orderBy(a.modelValue,["order","created_at"],["desc"]),set:n=>C("update:model-value",n)}),h=O(()=>g.modules[a.moduleKey]),ee=n=>{C("create:children",n),C("update:model-value",[...a.modelValue,n]),b.value=!1,d.onModalClose()},te=()=>{const n={component:X,props:{modal:!0,moduleKey:a.moduleKey,initialValues:a.initialValues},actions:{onClose:d.onModalClose,onCreate:ee}};d.addModal(n),d.show=!0},le=(n,i)=>{if(n.target.tagName==="DIV"){u.value=i.id;const $={component:X,props:{modal:!0,moduleKey:a.moduleKey,id:i.id},actions:{onClose:d.onModalClose}};d.addModal($),d.show=!0}},ae=()=>{console.log(f),f.value.forEach(async n=>{await B.patch(`/api/admin/${h.value.key}/${n.id}`,{[a.relationKey]:null}),C("update:model-value",a.modelValue.filter(i=>!f.value.includes(i)))})},oe=async(n,i)=>{o.value=!0;try{const{data:s}=await B.patch(`/api/admin/${h.value.key}/${n.id}`,{order:i});n.order=s.order;const $=a.modelValue.findIndex(se=>se.id===s.id);if($===-1)return;const N=[...a.modelValue];N.splice($,1,s),C("update:model-value",N)}catch(s){console.log(s)}finally{o.value=!1}},ie=async()=>{try{await Promise.all(r.value.map(n=>{B.patch(`/api/admin/${h.value.key}/${n.id}`,{[a.relationKey]:a.initialValues[a.relationKey]})})),C("update:model-value",[...a.modelValue,...r.value]),r.value=[],c.value=!1}catch(n){console.log(n)}},ne=async(n="")=>{try{const{data:i}=await B.get(`/api/admin/${h.value.key}`,{params:{search:n}});l.value=i}catch(i){console.log(i)}};return Te(()=>v.value,()=>{ne(v.value)}),F(J,oe),(n,i)=>(w(),S(E,{variant:"tonal",flat:"",loading:m(o),"prepend-icon":h.value.icon,class:"mb-8"},{title:t(()=>[T("span",Le,A(h.value.title),1)]),default:t(()=>[e(Fe,{modelValue:f.value,"onUpdate:modelValue":i[0]||(i[0]=s=>f.value=s),items:_.value,"onItem:click":le,"item-title":n.itemTitle},null,8,["modelValue","items","item-title"]),e(U),e(G,null,{default:t(()=>[e(z,{location:"top",text:"Создать",color:"primary"},{activator:t(({props:s})=>[e(p,K({icon:"",large:""},s,{loading:m(o),flat:"",onClick:te}),{default:t(()=>[e(j,null,{default:t(()=>[k("mdi-plus")]),_:1})]),_:2},1040,["loading"])]),default:t(()=>[Ne]),_:1}),e(z,{location:"top",text:"Удалить выбранное",color:"primary"},{activator:t(({props:s})=>[e(p,K({icon:"",large:"",loading:m(o)},s,{flat:"",onClick:ae}),{default:t(()=>[e(j,null,{default:t(()=>[k("mdi-delete")]),_:1})]),_:2},1040,["loading"])]),default:t(()=>[je]),_:1}),e(ye,{modelValue:c.value,"onUpdate:modelValue":i[5]||(i[5]=s=>c.value=s),"close-on-content-click":!1,location:"right",offset:"16"},{activator:t(s=>[e(z,{location:"top",text:"Поиск",color:"primary"},{activator:t($=>[e(p,K({icon:"",large:""},{...$.props,...s.props},{loading:m(o),flat:"",onClick:i[1]||(i[1]=N=>c.value=!0)}),{default:t(()=>[e(j,null,{default:t(()=>[k("mdi-magnify")]),_:1})]),_:2},1040,["loading"])]),default:t(()=>[ze]),_:2},1024)]),default:t(()=>[e(E,{width:"500"},{default:t(()=>[e(ge,null,{default:t(()=>[k("Найти")]),_:1}),e(Ce,{class:"mt-2"},{default:t(()=>[e(he,null,{default:t(()=>[e($e,null,{default:t(()=>[e(Se,{placeholder:"Поиск",modelValue:r.value,"onUpdate:modelValue":i[2]||(i[2]=s=>r.value=s),itemTitle:n.itemTitle,"return-object":"",chips:"",search:v.value,"onUpdate:search":i[3]||(i[3]=s=>v.value=s),items:l.value,multiple:""},null,8,["modelValue","itemTitle","search","items"])]),_:1})]),_:1})]),_:1}),e(U),e(G,null,{default:t(()=>[e(q),e(p,{variant:"text",onClick:i[4]||(i[4]=s=>(c.value=!1,r.value=[],v.value=""))},{default:t(()=>[k(" Отмена ")]),_:1}),e(p,{color:"primary",variant:"text",onClick:ie},{default:t(()=>[k(" Добавить ")]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),e(q)]),_:1})]),_:1},8,["loading","prepend-icon"]))}});export{Xe as _};
