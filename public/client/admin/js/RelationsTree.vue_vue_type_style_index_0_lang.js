import{p as de,G as re,N as me,g as ue,h as ce,a1 as D,a2 as O,V as p,a3 as ve,a4 as fe,a0 as pe,j as Ve,C as P,l as z,U as ye,E,W as ge,B as Ce,D as G,o as M}from"./index.js";import{l as L}from"./lodash.js";import{M as W}from"./ModuleDetail.js";import{I as e,l as j,i as B,r as V,U as ke,V as w,Q as S,R as t,u as m,J as K,Z as R,_ as k,a5 as q,af as we,a9 as T,F as Q,X,W as Z,j as U,q as N,w as Te}from"./vue-codemirror.js";import{V as A}from"./VTooltip.js";import{V as he,a as $e}from"./VRow.js";import{V as Se}from"./VAutocomplete.js";import{V as J}from"./VSpacer.js";const Ie=de({start:Boolean,end:Boolean,...re(),...me()},"VListItemAction"),b=ue()({name:"VListItemAction",props:Ie(),setup(a,y){let{slots:d}=y;return ce(()=>e(a.tag,{class:["v-list-item-action",{"v-list-item-action--start":a.start,"v-list-item-action--end":a.end},a.class],style:a.style},d)),{}}}),H=Symbol(),Y=Symbol(),x=Symbol(),be={style:{"margin-left":"-12px"}},Be={style:{"margin-left":"32px"}},Me={style:{"margin-left":"-12px"}},Ke=j({__name:"TreeViewItem",props:{item:{},itemTitle:{type:[Function,String]}},setup(a){const y=B("selected",V([])),d=B(Y,()=>{}),g=B(H,async()=>{}),c=B(x,()=>{}),v=l=>{if(typeof a.itemTitle=="function")return a.itemTitle(l);{const o=a.itemTitle;return L.get(l,o)}},r=l=>L.orderBy(l,["order","created_at"],["desc"]);return(l,o)=>{const I=ke("tree-view-item",!0);return l.item.children&&l.item.children.length?(w(),S(ve,{key:0,"expand-icon":void 0},{activator:t(({props:u,isOpen:C})=>[e(D,K({onClick:o[3]||(o[3]=f=>m(c)(f,l.item))},{class:u.class,id:u.id}),{title:t(()=>[q(l.$slots,"content",{item:l.item},()=>[k(R(v(l.item)),1)])]),prepend:t(()=>[e(b,{start:""},{default:t(()=>[e(O,{"model-value":m(y).includes(l.item.id),onClick:o[0]||(o[0]=f=>m(d)(l.item))},null,8,["model-value"])]),_:1}),e(b,{start:""},{default:t(()=>[e(p,{icon:"mdi-chevron-down",variant:"text",size:"small",onClick:u.onClick,class:we(["expand-icon",{active:C}])},null,8,["onClick","class"])]),_:2},1024)]),append:t(()=>[e(b,{end:""},{default:t(()=>[T("div",be,[e(p,{icon:"mdi-arrow-up-bold-circle-outline",size:"small",variant:"text",onClick:o[1]||(o[1]=f=>m(g)(l.item,Number(l.item.order)+1))}),e(p,{icon:"mdi-arrow-down-bold-circle-outline",size:"small",variant:"text",onClick:o[2]||(o[2]=f=>m(g)(l.item,Number(l.item.order)-1))})])]),_:1})]),_:2},1040)]),default:t(()=>[T("div",Be,[(w(!0),Z(Q,null,X(r(l.item.children),u=>(w(),S(I,{key:u.id,item:u,"item-title":l.itemTitle},null,8,["item","item-title"]))),128))])]),_:3})):(w(),S(D,{key:1,onClick:o[7]||(o[7]=u=>m(c)(u,l.item))},{title:t(()=>[q(l.$slots,"content",{item:l.item},()=>[k(R(v(l.item)),1)])]),prepend:t(()=>[e(b,{start:""},{default:t(()=>[e(O,{"model-value":m(y).includes(l.item.id),onClick:o[4]||(o[4]=u=>m(d)(l.item))},null,8,["model-value"])]),_:1})]),append:t(()=>[e(b,{end:""},{default:t(()=>[T("div",Me,[e(p,{icon:"mdi-arrow-up-bold-circle-outline",size:"small",flat:"",onClick:o[5]||(o[5]=u=>m(g)(l.item,Number(l.item.order)+1))}),e(p,{icon:"mdi-arrow-down-bold-circle-outline",size:"small",flat:"",onClick:o[6]||(o[6]=u=>m(g)(l.item,Number(l.item.order)-1))})])]),_:1})]),_:3}))}}}),Ne=j({__name:"TreeView",props:{items:{default:()=>[]},itemTitle:{},modelValue:{default:()=>[]}},emits:["update:model-value","item:click"],setup(a,{emit:y}){const d=y,g=U(()=>L.orderBy(a.items,["order","created_at"],["desc"])),c=r=>{const l=[...a.modelValue,r];d("update:model-value",l)},v=(r,l)=>d("item:click",r,l);return N("selected",a.modelValue),N(Y,c),N(x,v),(r,l)=>(w(),S(fe,{density:"compact",nav:"","return-object":""},{default:t(()=>[(w(!0),Z(Q,null,X(g.value,(o,I)=>(w(),S(Ke,{key:I,item:o,"item-title":r.itemTitle},null,8,["item","item-title"]))),128))]),_:1}))}}),Le={class:"ml-2"},Fe=T("span",null,"Создать",-1),ze=T("span",null,"Удалить выбранное",-1),Ae=T("span",null,"Поиск",-1),We=j({__name:"RelationsTree",props:{modelValue:{default:()=>[]},moduleKey:{},relationKey:{},initialValues:{},itemTitle:{default:"name"}},emits:["update:model-value","create:children"],setup(a,{emit:y}){const d=pe(),g=Ve(),c=V(!1),v=V(""),r=V([]),l=V([]),o=B("loading",V(!1)),I=V(!1),u=V(),C=y,f=V([]),_=U({get:()=>L.orderBy(a.modelValue,["order","created_at"],["desc"]),set:n=>C("update:model-value",n)}),h=U(()=>g.modules[a.moduleKey]),ee=n=>{C("create:children",n),C("update:model-value",[...a.modelValue,n]),I.value=!1,d.onModalClose()},te=()=>{const n={component:W,props:{modal:!0,moduleKey:a.moduleKey,initialValues:a.initialValues},actions:{onClose:d.onModalClose,onCreate:ee}};d.addModal(n),d.show=!0},le=(n,i)=>{if(n.target.tagName==="DIV"){u.value=i.id;const $={component:W,props:{modal:!0,moduleKey:a.moduleKey,id:i.id},actions:{onClose:d.onModalClose}};d.addModal($),d.show=!0}},ae=()=>{console.log(f),f.value.forEach(async n=>{await M.patch(`/api/admin/${h.value.key}/${n.id}`,{[a.relationKey]:null}),C("update:model-value",a.modelValue.filter(i=>!f.value.includes(i)))})},oe=async(n,i)=>{o.value=!0;try{const{data:s}=await M.patch(`/api/admin/${h.value.key}/${n.id}`,{order:i});n.order=s.order;const $=a.modelValue.findIndex(se=>se.id===s.id);if($===-1)return;const F=[...a.modelValue];F.splice($,1,s),C("update:model-value",F)}catch(s){console.log(s)}finally{o.value=!1}},ie=async()=>{try{await Promise.all(r.value.map(n=>{M.patch(`/api/admin/${h.value.key}/${n.id}`,{[a.relationKey]:a.initialValues[a.relationKey]})})),C("update:model-value",[...a.modelValue,...r.value]),r.value=[],c.value=!1}catch(n){console.log(n)}},ne=async(n="")=>{try{const{data:i}=await M.get(`/api/admin/${h.value.key}`,{params:{search:n}});l.value=i}catch(i){console.log(i)}};return Te(()=>v.value,()=>{ne(v.value)}),N(H,oe),(n,i)=>(w(),S(E,{variant:"tonal",flat:"",loading:m(o),"prepend-icon":h.value.icon,class:"mb-8"},{title:t(()=>[T("span",Le,R(h.value.title),1)]),default:t(()=>[e(Ne,{modelValue:f.value,"onUpdate:modelValue":i[0]||(i[0]=s=>f.value=s),items:_.value,"onItem:click":le,"item-title":n.itemTitle},null,8,["modelValue","items","item-title"]),e(P),e(G,null,{default:t(()=>[e(A,{location:"top",text:"Создать",color:"primary"},{activator:t(({props:s})=>[e(p,K({icon:"",large:""},s,{loading:m(o),flat:"",onClick:te}),{default:t(()=>[e(z,null,{default:t(()=>[k("mdi-plus")]),_:1})]),_:2},1040,["loading"])]),default:t(()=>[Fe]),_:1}),e(A,{location:"top",text:"Удалить выбранное",color:"primary"},{activator:t(({props:s})=>[e(p,K({icon:"",large:"",loading:m(o)},s,{flat:"",onClick:ae}),{default:t(()=>[e(z,null,{default:t(()=>[k("mdi-delete")]),_:1})]),_:2},1040,["loading"])]),default:t(()=>[ze]),_:1}),e(ye,{modelValue:c.value,"onUpdate:modelValue":i[5]||(i[5]=s=>c.value=s),"close-on-content-click":!1,location:"right",offset:"16"},{activator:t(s=>[e(A,{location:"top",text:"Поиск",color:"primary"},{activator:t($=>[e(p,K({icon:"",large:""},{...$.props,...s.props},{loading:m(o),flat:"",onClick:i[1]||(i[1]=F=>c.value=!0)}),{default:t(()=>[e(z,null,{default:t(()=>[k("mdi-magnify")]),_:1})]),_:2},1040,["loading"])]),default:t(()=>[Ae]),_:2},1024)]),default:t(()=>[e(E,{width:"500"},{default:t(()=>[e(ge,null,{default:t(()=>[k("Найти")]),_:1}),e(Ce,{class:"mt-2"},{default:t(()=>[e(he,null,{default:t(()=>[e($e,null,{default:t(()=>[e(Se,{placeholder:"Поиск",modelValue:r.value,"onUpdate:modelValue":i[2]||(i[2]=s=>r.value=s),itemTitle:n.itemTitle,"return-object":"",chips:"",search:v.value,"onUpdate:search":i[3]||(i[3]=s=>v.value=s),items:l.value,multiple:""},null,8,["modelValue","itemTitle","search","items"])]),_:1})]),_:1})]),_:1}),e(P),e(G,null,{default:t(()=>[e(J),e(p,{variant:"text",onClick:i[4]||(i[4]=s=>(c.value=!1,r.value=[],v.value=""))},{default:t(()=>[k(" Отмена ")]),_:1}),e(p,{color:"primary",variant:"text",onClick:ie},{default:t(()=>[k(" Добавить ")]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),e(J)]),_:1})]),_:1},8,["loading","prepend-icon"]))}});export{We as _};
